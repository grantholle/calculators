define(["app/calculator","fastclick","magnific","iscroll","waypoints"],function(t){(function(){var e=$("div.toggle-group"),a=$("a#share-button"),n=$("div.increment-input"),i=$("div.tabbed"),o=$("body"),r=$(window),s=$("div.modal"),c=$("i.icon-tooltip"),d=$("input[type=currency]"),p=$("span#fuel-difference"),l=($("header img#header-img"),$("a#send-link")),u=$("a.see-results"),f=$("section#results"),v=$(".exportable"),g=$("div.perc-slider"),h=e.find("button.active").data("compare"),m=!1,y="http://www.propanecostcalculator.com/scripts/email.php",C=!1,w=r.width(),b=function(){FastClick.attach(document.body),T(),F()},T=function(){r.on("resize",function(){w=r.width(),L(),N()}),f.waypoint(function(t){u.toggleClass("unstick").removeClass("ready"),u.hasClass("unstick")?f.css({paddingTop:12}):f.css({paddingTop:u.outerHeight()+12})},{offset:function(){return $(document).scrollTop()+$.waypoints("viewportHeight")>f.offset().top?$.waypoints("viewportHeight"):$.waypoints("viewportHeight")-u.outerHeight()}}),d.on("touchstart",function(t){var e=$(t.currentTarget);e.data("original-string",e.val()),e.attr("type","number").focus()}),e.on("click","button",function(t){$target=$(t.currentTarget),$target.hasClass("active")||H($target)}),n.on("touchstart","button",function(t){$(t.currentTarget).addClass("active")}).on("touchend, touchcancel, click","button",function(t){var e,a=$(t.currentTarget).parent().find("input[type=number]"),n=parseInt(a.val(),10),i=parseInt(a.data("min"),10),r=parseInt(a.data("max"),10),s=parseInt($(t.currentTarget).data("value"),10),c=n+s;e=i>c?i:c>r?r:c,a.val(e),o.trigger("changesMade"),$(t.currentTarget).removeClass("active")}),g.on("change",function(t){o.trigger("changesMade")}).on("showToolTips",function(t){$(t.currentTarget).parents(".has-slider").find(".tooltip").show()}),c.click(function(t){var e=$(t.currentTarget),a=e.find("div.tab-tooltip");a.toggleClass("active"),a.offset().top<r.scrollTop()&&o.animate({scrollTop:a.offset().top-10},400)}),o.on("focus","input[type=text], input[type=number], input[type=currency]",function(t){var e=$(t.currentTarget);""!==e.val()&&e.data("original-string",e.val()),e.val("")}).on("keypress","input[type=text], input[type=number], input[type=currency]",function(t){13===t.keyCode&&$(t.currentTarget).blur()}).on("blur","input[type=text], input[type=number], input[type=currency]",function(t){var e=$(t.currentTarget),a=e.val().replace("$","");if(""===a)e.parent().hasClass("tooltip")&&"number"===e.attr("type")&&e.attr("type","currency"),e.val(e.data("original-string"));else if(e.parent().hasClass("increment-input"))A(e);else{var n=e.parents("div.slider-wrapper, div.range-wrapper").find("div.perc-slider");"number"===e.attr("type")&&e.attr("type","currency"),n.hasClass("range-slider")?e.parent().hasClass("tooltip-top")?n.val([a,null]):n.val([null,a]):n.val(a)}o.trigger("changesMade")}).on("slidersInitialized",function(t){N(),x(),o.trigger("changesMade")}).on("changesMade",function(e){u.addClass("ready"),t.refresh(h)}).on("refreshWaypoint",function(){$.waypoints("refresh")}).on("moveTooltip",M),i.on("click","li",function(t){var e=$(t.currentTarget);if(!e.hasClass("active")){var a=e.parents("div.tabbed"),n=e.data("tab");a.find("li.active").removeClass("active"),a.find("div.result-data").removeClass("active"),a.find("div."+n).addClass("active"),e.addClass("active")}}),a.magnificPopup({showCloseBtn:!1,callbacks:{open:function(){I()||(s.find("div.default").hide(),s.find("div.no-connection").show())},close:function(){s.find("input[type=text]").val(""),s.find("div.default").show(),s.find("div.thank-you").hide(),s.find("div.no-connection").hide(),C=!1,l.removeClass("disabled")}}}),l.click(function(e){if(e.preventDefault(),!C){C=!0,l.addClass("disabled");var a={data:JSON.stringify({app:window.app,results:window.btoa(JSON.stringify(t.results())),"import":k(),email:s.find("input[type=text]").val()})};$.ajax({type:"GET",cache:!1,data:a,url:y}).done(function(){s.find("div.default").hide(),s.find("div.thank-you").show()})}}),s.on("click","div.close",function(t){$.magnificPopup.close()}),u.click(function(t){var e=$(document).scrollTop()+$.waypoints("viewportHeight")>f.offset().top?f.offset().top:f.offset().top+u.outerHeight();t.preventDefault(),u.hasClass("ready")&&(e-=18),m&&(e-=20),u.removeClass("ready"),o.animate({scrollTop:e},500)})},k=function(){var t={competitor:h,values:{}};return v.each(function(e,a){var n=$(a),i=n.val();"object"!=typeof i?n.hasClass("no-validation")?t.values[n.attr("id")]=i:t.values[n.attr("id")]=i.replace(/[A-Za-z$-,]/g,""):(t.values[n.attr("id")]=[],$.each(i,function(e,a){t.values[n.attr("id")].push(parseFloat(a.replace(/[A-Za-z$-,]/g,"")))}))}),t},x=function(){var t=z("data");t&&(t=$.parseJSON(window.atob(t)),"undefined"!=typeof t.competitor&&(e.find("button").removeClass("active"),e.find("button[data-compare="+t.competitor+"]").addClass("active"),h=t.competitor,formattedCompetitor=O(t.competitor),o.find(".compare").html(formattedCompetitor)),$.each(t.values,function(t,e){$("#"+t).val(e)}))},I=function(){return navigator.onLine?"undefined"!=typeof navigator.connection&&navigator.connection.type===Connection.NONE?!1:!0:!1},H=function(t){h=t.data("compare"),formattedCompetitor=O(h),e.find("button.active").removeClass("active"),t.addClass("active"),o.find(".compare").html(formattedCompetitor),o.trigger("swapCompetitor"),o.trigger("changesMade")},M=function(t,e,a,n,i){if(a&&e.find("input").val(a),400>=w?e.css("left",n):768>w?e.css("left",n+1):e.css("left",n+6),i&&a){var r,s,c,d=i.val();"undefined"!=typeof d[1]&&(r=parseFloat(d[1].replace("$","")),s=parseFloat(d[0].replace("$","")),c=Math.abs(r-s),p.html("$"+c.toFixed(2)))}o.trigger("refreshWaypoint")},F=function(){"undefined"!=typeof device&&"ios"===device.platform.toLowerCase()?(o.css({paddingTop:20}),o.find("div.ios-padding").show(),m=!0):(o.removeAttr("style"),o.find("div.ios-padding").hide(),m=!1)},L=function(){g.each(function(t,e){var a=$(e),n=a.find("div.noUi-origin"),i=a.parent().find("div.tooltip");"undefined"!=typeof a.find("div.noUi-origin")[1]?(o.trigger("moveTooltip",[i.first(),!1,n[0].offsetLeft,!1]),o.trigger("moveTooltip",[i.last(),!1,n[1].offsetLeft,!1])):o.trigger("moveTooltip",[i,!1,n[0].offsetLeft,!1])})},N=function(){o.outerHeight()<r.outerHeight()?o.addClass("extend"):o.removeClass("extend")},z=function(t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+t+"=([^&#]*)"),a=e.exec(location.search);return null===a?"":decodeURIComponent(a[1].replace(/\+/g," "))},A=function(t){var e,a=parseInt(t.val(),10),n=parseInt(t.data("min"),10),i=parseInt(t.data("max"),10),o=parseInt(t.data("step"),10),r=a%o;e=n>a?n:a>i?i:0!==r?r>=o/2?a+(o-r):a-r:a,t.val(e)},O=function(t){return t.charAt(0).toUpperCase()+t.slice(1)};b()})()});